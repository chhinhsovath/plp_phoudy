# Run these commands on the server (ssh ubuntu@157.10.73.52):

# 1. Upload deployment package first (run from local machine):
# scp plp-backend-deploy.tar.gz ubuntu@157.10.73.52:/home/ubuntu/

# 2. Then run these on the server:
rm -rf plp-phoudy
mkdir -p plp-phoudy && cd plp-phoudy
tar -xzf ../plp-backend-deploy.tar.gz

# Install Node.js if needed
if ! command -v node &> /dev/null; then
    curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
    sudo apt-get install -y nodejs
fi

# Install dependencies
npm install

# Build the project
npm run build

# Stop any existing Node processes
pkill -f 'node.*dist/main' || true

# Start the application
NODE_ENV=production nohup node dist/main.js > app.log 2>&1 &

# Wait a moment
sleep 5

# Check if it's running
ps aux | grep "node.*dist/main" | grep -v grep

# Test locally on server
curl http://localhost:8080/api/v1/health

# Open firewall
sudo ufw allow 8080

# Test again
curl http://localhost:8080/api/v1/health
